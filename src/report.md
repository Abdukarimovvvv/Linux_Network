## Part 1. **ipcalc** tool
### 1.1. Сети и маски

#### Определить и записать в отчёт:

##### 1) Адрес сети 192.167.38.54/13
![](./screen/1.png)

##### 2) Перевод маски 255.255.255.0 в префиксную и двоичную запись

![](./screen/2.png)

``` brew
/15 в обычную и двоичную
```
![](./screen/3.png)
``` brew
11111111.11111111.11111111.11110000 в обычную и префиксную
```
![](./screen/4.png)

##### 3) Минимальный и максимальный хост в сети 12.167.38.4 при маске /8

![](./screen/5.png)
``` brew
Минимальный и максимальный хост в сети 12.167.38.4 при маске 11111111.11111111.00000000.00000000
```
![](./screen/6.png)
``` brew
Минимальный и максимальный хост в сети 12.167.38.4 при маске 255.255.254.0
```
![](./screen/7.png)
``` brew
Минимальный и максимальный хост в сети 12.167.38.4 при маске /4
```
![](./screen/8.png)

### 1.2. localhost
1. Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1
``` brew
* Можно:      
127.1.0.1;    
128.0.0.1. 
* Нельзя:          
194.34.23.100;           
128.0.0.1.
```

### 1.3. Диапазоны и сегменты сетей
Определить и записать в отчёт:
1. какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: `10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1`
``` brew
* В качестве публичного: 134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1.
* В качестве чаcтных: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10.
```
2. какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
``` brew
* Возможны: 10.10.0.2, 10.10.10.10, 10.10.1.255
* Невозможны: 10.0.0.1, 10.10.100.1.
```

## Part 2. Static routing between two machines

##### С помощью команды `ip a` посмотреть существующие сетевые интерфейсы
- В отчёт поместить скрин с вызовом и выводом использованной команды.

*Вызов и вывод команды `ip a` для ws1*
![](./screen/11.png)

*Вызов и вывод команды `ip a` для ws2*
![](./screen/12.png)

##### Задать на обеих машинах следующие адреса и маски: ws1 - *192.168.100.10*, маска */16*, ws2 - *172.24.116.8*, маска */12*
- В отчёт поместить скрины с содержанием изменённого файла *etc/netplan/00-installer-config.yaml* с вызовом и выводом команды `netplan apply` для каждой машины.

*Измененный файл для ws1 с вызовом и выводом команды `netplan apply`*
![](./screen/13.png)

*Измененный файл для ws2 с вызовом и выводом команды `netplan apply`*
![](./screen/14.png)

### 2.1. Добавление статического маршрута вручную
- Добавление статического маршрута для `ws1`
![](./screen/15.png)

- Добавление статического маршрута для `ws2`
![](./screen/16.png)

#### Пропинговать соединение между машинами
- #### `ws1`
![](./screen/17.png)

- #### `ws2`
![](./screen/18.png)

### 2.2. Добавление статического маршрута с сохранением
Добавить статический маршрут от одной машины до другой с помощью файла `etc/netplan/00-installer-config.yaml`

![](./screen/19.png)
![](./screen/20.png)

#### Пропинговать соединение между машинами
![](./screen/20.1.png)
![](./screen/20.2.png)

## Part 3. **iperf3** utility

### 3.1. Скорость соединения

#### Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps
- `8Mbps == 1MB/s;`
- `100MB/s == 819200 Kbps;`
- `1Gbps == 1024 Mbps.`

### 3.2. Утилита iperf3

#### Измерить скорость соединения между ws1 и ws2
![](./screen/22.png)
![](./screen/23.png)

## Part 4. Network firewall

### 4.1 Утилита iptables
Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2.
Нужно добавить в файл подряд следующие правила:

1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)

2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)

3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)

4) запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)

5) разрешить echo reply (машина должна "пинговаться")

- #### `ws1`
![](./screen/24.png)
- #### `ws2`
![](./screen/25.png)

- #### `Запустить файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh`
- #### `ws1`
![](./screen/26.png)
- #### `ws2`
![](./screen/27.png)

### 4.2 Утилита nmap
- Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен
- #### `ws1`
![](./screen/28.png)
- #### `ws2`
![](./screen/29.png)
`Видно из скрина что, хост 1ой машины запущен, но не пингуется`

## Part 5. Static network routing
- Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))
![](./screen/29.1.png)

### 5.1 Настройка адресов машин
Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.
![](./screen/30.png)
![](./screen/31.png)
![](./screen/32.png)
![](./screen/33.png)
![](./screen/34.png)

- Перезапустить сервис сети. Если ошибок нет, то командой ip -4 a проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.
`ip -4 a`
- #### `ws11`
![](./screen/35.png)
- #### `ws21`
![](./screen/36.png)
- #### `ws22`
![](./screen/37.png)
- #### `r1`
![](./screen/38.png) 
- #### `r2`
![](./screen/39.png)

- Пропинговать ws22 с ws21 и r1 с ws11.
![](./screen/40.png)
![](./screen/41.png)

### 5.2. Включение переадресации IP-адресов.
Для включения переадресации IP, выполнить команду на роутерах:
`sysctl -w net.ipv4.ip_forward=1`
![](./screen/42.png)
![](./screen/43.png)

- Откройте файл /etc/sysctl.conf и добавьте в него следующую строку:
`net.ipv4.ip_forward = 1`
![](./screen/44.png)
![](./screen/45.png)

### 5.3 Установка маршрута по-умолчанию
Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить gateway4 [ip роутера] в файле конфигураций
Вызвать ip r и показать, что добавился маршрут в таблицу маршрутизации
`ip r`

- #### `ws11`
![](./screen/46.png)
- #### `ws21`
![](./screen/47.png)
- #### `ws22`
![](./screen/48.png)

Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:
`tcpdump -tn -i eth1`
![](./screen/49.png)
![](./screen/50.png)

### 5.4. Добавление статических маршрутов
- Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.
![](./screen/51.png)
![](./screen/52.png)

Вызвать ip r и показать таблицы с маршрутами на обоих роутерах. Пример таблицы на r1:
`ip r`
![](./screen/53.png)
![](./screen/54.png)

Запустить команды на ws11:
`ip r list 10.10.0.0/[18]`
`ip r list 0.0.0.0/0`
![](./screen/55.png)
- Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, поскольку он является адресом сети и доступен без шлюза.

### 5.5. Построение списка маршрутизаторов
Запустить на r1 команду дампа
`tcpdump -tnv -i eth0`
![](./screen/56.png)

При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21
![](./screen/57.png)
Для определения промежуточных маршрутизаторов traceroute отправляет целевому узлу серию ICMP-пакетов (по умолчанию 3 пакета), с каждым шагом увеличивая значение поля TTL («время жизни») на 1. Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первая серия пакетов отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно ICMP-сообщение «time exceeded in transit», указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку серии пакетов, но уже с TTL, равным 2, что заставляет первый маршрутизатор уменьшить TTL пакетов на единицу и направить их ко второму маршрутизатору. Второй маршрутизатор, получив пакеты с TTL=1, так же возвращает «time exceeded in transit».

Процесс повторяется до тех пор, пока пакет не достигнет целевого узла, тем самым увеличивая значение ttl. При получении ответа от этого узла процесс трассировки считается завершённым.

### 5.6. Использование протокола ICMP при маршрутизации
Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i eth0 icmp`
![](./screen/58.png)

Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:
`ping -c 1 10.30.0.111`
![](./screen/59.png)

## Part 6. Dynamic IP configuration using DHCP
##### 1) Для r2 настроить в файле `*/etc/dhcp/dhcpd.conf*` конфигурацию службы **DHCP**. Указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.
![](./screen/60.png)

##### 2) В файле `*resolv.conf*` прописать `nameserver 8.8.8.8.`
![](./screen/61.png)

Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`.
![](./screen/62.png)

Машину **ws21** перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.
![](./screen/63.png)
![](./screen/64.png)

Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`
![](./screen/65.png)

Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты
В файле /etc/dhcp/dhcpd.conf настроить конфигурацию службы DHCP с жесткой привязкой к MAC-адресу (ws11)
![](./screen/66.png)

В файле resolv.conf прописать nameserver 8.8.8.8 (DNS)
![](./screen/67.png)

`ip` до обновления и после.
![](./screen/68.png)

Запросить с ws21 обновление ip адреса
![](./screen/69.png)
![](./screen/69.1.png)

- В отчёте описать, какими опциями **DHCP** сервера пользовались в данном пункте.

  **dhclient -v** - получение нового ip;
  **dhclient -r** - удаление старых (всех) ip;

```shell
subnet 10.20.0.0 netmask 255.255.255.192
{
    range 10.20.0.2 10.20.0.50; - диапазон доступных IP адресов
    option routers 10.20.0.1; - адрес шлюза маршрутизатора
    option domain-name-servers 10.20.0.1; IP адресс DNS-сервера
}
```

## Part 7. NAT
В файле `/etc/apache2/ports.conf` на ws22 и r1 изменить строку **Listen 80** на **Listen 0.0.0.0:80**, то есть сделать сервер Apache2 общедоступным
![](./screen/70.png)
![](./screen/70.1.png)

Запустить веб-сервер Apache командой service apache2 start на ws22 и r1
![](./screen/71.png)
![](./screen/71.1.png)

Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

**1) Удаление правил в таблице filter - iptables -F**


**2) Удаление правил в таблице "NAT" - iptables -F -t nat**


**3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP**
![](./screen/72.png)

Запускать файл также, как в Части 4

Проверить соединение между ws22 и r1 командой ping

При запуске файла с этими правилами, ws22 **не должна "пинговаться"** с r1
![](./screen/73.png)
![](./screen/73.1.png)

Добавить в файл ещё одно правило:

**4) Разрешить маршрутизацию всех пакетов протокола ICMP**
![](./screen/74.png)

Проверить соединение между ws22 и r1 командой `ping`
![](./screen/75.png)

Добавить в файл ещё два правила:

**5)** Включить **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
Включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
![](./screen/76.png)

Проверить соединение по TCP для **SNAT**, для этого с ws22 подключиться к серверу Apache на r1.
![](./screen/77.png)

Проверить соединение по TCP для **DNAT**, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet`
![](./screen/78.png)

## Part 8. Bonus. Introduction to SSH Tunnels
Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку Listen 80 на Listen localhost:80)
![](./screen/79.png)

Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21
![](./screen/80.png)

**с ws21 до ws22**
![](./screen/81.png)
**ws22 с ws21**
![](./screen/82.png)

Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11
**c ws11 до ws22**
![](./screen/83.png)
**ws22 с ws11**
![](./screen/84.png)

Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:
![](./screen/85.png)
